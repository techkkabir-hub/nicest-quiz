<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>NCERT Quiz - ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡•Ä ‡§§‡•à‡§Ø‡§æ‡§∞‡•Ä</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --saffron: #FF6B00;
    --deep-saffron: #E55A00;
    --gold: #FFB300;
    --light-gold: #FFF3CD;
    --green: #1B5E20;
    --light-green: #E8F5E9;
    --blue: #0D47A1;
    --light-blue: #E3F2FD;
    --white: #FFFDF7;
    --dark: #1A1A2E;
    --card-bg: #FFFFFF;
    --shadow: 0 4px 20px rgba(255,107,0,0.15);
    --radius: 16px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Baloo 2', 'Noto Sans Devanagari', sans-serif;
    background: linear-gradient(135deg, #FFF8F0 0%, #FFF3E0 50%, #F3E5F5 100%);
    min-height: 100vh;
    color: var(--dark);
    overflow-x: hidden;
  }

  /* HEADER */
  .header {
    background: linear-gradient(135deg, var(--saffron), #FF8C00, var(--gold));
    padding: 16px 16px 20px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 120px; height: 120px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
  }
  .header::after {
    content: 'üìö';
    position: absolute;
    top: 10px; right: 16px;
    font-size: 32px;
    opacity: 0.6;
  }
  .header h1 {
    color: white;
    font-size: 22px;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    letter-spacing: 0.5px;
  }
  .header p {
    color: rgba(255,255,255,0.9);
    font-size: 12px;
    margin-top: 2px;
  }

  /* TABS - Subject Switcher */
  .subject-tabs {
    display: flex;
    gap: 8px;
    padding: 12px 12px 0;
    overflow-x: auto;
    scrollbar-width: none;
    background: white;
    border-bottom: 2px solid #F0E6D3;
  }
  .subject-tabs::-webkit-scrollbar { display: none; }
  
  .tab-btn {
    flex-shrink: 0;
    padding: 8px 14px;
    border: none;
    border-radius: 20px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease;
    background: #F5F5F5;
    color: #666;
    border: 2px solid transparent;
  }
  .tab-btn.active {
    background: var(--saffron);
    color: white;
    border-color: var(--deep-saffron);
    box-shadow: 0 3px 10px rgba(255,107,0,0.3);
    transform: translateY(-1px);
  }
  .tab-btn:hover:not(.active) {
    background: #FFE0CC;
    color: var(--saffron);
  }

  /* CLASS SELECTOR */
  .class-row {
    display: flex;
    gap: 6px;
    padding: 10px 12px;
    overflow-x: auto;
    scrollbar-width: none;
    background: white;
    border-bottom: 1px solid #F0E6D3;
  }
  .class-row::-webkit-scrollbar { display: none; }
  .class-btn {
    flex-shrink: 0;
    padding: 5px 12px;
    border: 2px solid #DDD;
    border-radius: 12px;
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    background: white;
    color: #888;
    transition: all 0.2s;
  }
  .class-btn.active {
    border-color: var(--blue);
    background: var(--light-blue);
    color: var(--blue);
  }

  /* STATS BAR */
  .stats-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 16px;
    background: white;
    border-bottom: 1px solid #F0E6D3;
  }
  .stat {
    text-align: center;
  }
  .stat-val {
    font-size: 20px;
    font-weight: 800;
    color: var(--saffron);
    line-height: 1;
  }
  .stat-val.green { color: #2E7D32; }
  .stat-val.red { color: #C62828; }
  .stat-label {
    font-size: 10px;
    color: #888;
    margin-top: 2px;
  }

  /* MAIN CONTENT */
  .main {
    padding: 12px;
    max-width: 600px;
    margin: 0 auto;
  }

  /* QUESTION CARD */
  .question-card {
    background: white;
    border-radius: var(--radius);
    padding: 18px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
    border-left: 5px solid var(--saffron);
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .q-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .q-badge {
    background: var(--light-gold);
    color: #8B6914;
    font-size: 11px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid #FFD54F;
  }
  .q-exam-tag {
    background: #E8EAF6;
    color: #3949AB;
    font-size: 10px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 10px;
  }

  .q-text-hi {
    font-size: 15px;
    font-weight: 700;
    color: var(--dark);
    line-height: 1.6;
    margin-bottom: 6px;
    font-family: 'Noto Sans Devanagari', sans-serif;
  }
  .q-text-en {
    font-size: 13px;
    color: #555;
    line-height: 1.5;
    font-style: italic;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #EEE;
  }

  /* OPTIONS */
  .options {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .option-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border: 2px solid #E8E8E8;
    border-radius: 12px;
    background: #FAFAFA;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    font-family: inherit;
    width: 100%;
  }
  .option-btn:hover:not(:disabled) {
    border-color: var(--saffron);
    background: #FFF5EC;
    transform: translateX(3px);
  }

  .opt-letter {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #F0F0F0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 800;
    flex-shrink: 0;
    color: #666;
    transition: all 0.2s;
  }
  .opt-text {
    flex: 1;
  }
  .opt-text-hi {
    font-size: 13px;
    font-weight: 600;
    color: var(--dark);
    font-family: 'Noto Sans Devanagari', sans-serif;
  }
  .opt-text-en {
    font-size: 11px;
    color: #888;
    font-style: italic;
  }

  /* CORRECT/WRONG states */
  .option-btn.correct {
    border-color: #2E7D32;
    background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
    animation: correctPop 0.4s ease;
  }
  .option-btn.correct .opt-letter {
    background: #2E7D32;
    color: white;
  }
  @keyframes correctPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.03); }
    100% { transform: scale(1); }
  }

  .option-btn.wrong {
    border-color: #C62828;
    background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
  }
  .option-btn.wrong .opt-letter {
    background: #C62828;
    color: white;
  }

  .option-btn.reveal-correct {
    border-color: #2E7D32;
    background: #E8F5E9;
    opacity: 0.7;
  }

  /* EXPLANATION */
  .explanation {
    margin-top: 12px;
    padding: 12px;
    background: linear-gradient(135deg, #FFF8E1, #FFF3CD);
    border-radius: 10px;
    border-left: 4px solid var(--gold);
    animation: fadeIn 0.4s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .exp-title {
    font-size: 12px;
    font-weight: 700;
    color: #7B5800;
    margin-bottom: 6px;
  }
  .exp-text {
    font-size: 13px;
    color: #5D4037;
    line-height: 1.6;
    font-family: 'Noto Sans Devanagari', sans-serif;
  }
  .exp-text-en {
    font-size: 11px;
    color: #795548;
    font-style: italic;
    margin-top: 4px;
  }

  /* NEXT BUTTON */
  .next-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--saffron), var(--deep-saffron));
    color: white;
    border: none;
    border-radius: 14px;
    font-family: inherit;
    font-size: 16px;
    font-weight: 800;
    cursor: pointer;
    margin-top: 10px;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(255,107,0,0.35);
    letter-spacing: 0.5px;
    display: none;
  }
  .next-btn.visible {
    display: block;
    animation: fadeIn 0.3s ease;
  }
  .next-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255,107,0,0.4);
  }
  .next-btn:active {
    transform: translateY(0);
  }

  /* LOADING */
  .loading-card {
    background: white;
    border-radius: var(--radius);
    padding: 40px 20px;
    text-align: center;
    box-shadow: var(--shadow);
  }
  .loader {
    display: inline-block;
    width: 40px; height: 40px;
    border: 4px solid #FFE0CC;
    border-top-color: var(--saffron);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    color: var(--saffron);
    font-size: 15px;
    font-weight: 700;
  }
  .loading-sub {
    color: #AAA;
    font-size: 12px;
    margin-top: 4px;
  }

  /* ERROR */
  .error-card {
    background: #FFF3E0;
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    border: 2px solid #FFB300;
    display: none;
  }
  .error-card.visible { display: block; }
  .retry-btn {
    margin-top: 12px;
    padding: 10px 24px;
    background: var(--saffron);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: inherit;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
  }

  /* API KEY INPUT */
  .api-setup {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    text-align: center;
  }
  .api-setup h2 {
    font-size: 18px;
    color: var(--saffron);
    margin-bottom: 8px;
  }
  .api-setup p {
    font-size: 13px;
    color: #666;
    margin-bottom: 16px;
    line-height: 1.5;
  }
  .api-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #DDD;
    border-radius: 10px;
    font-family: inherit;
    font-size: 13px;
    margin-bottom: 10px;
    outline: none;
    transition: border-color 0.2s;
  }
  .api-input:focus { border-color: var(--saffron); }
  .api-save-btn {
    width: 100%;
    padding: 12px;
    background: var(--saffron);
    color: white;
    border: none;
    border-radius: 10px;
    font-family: inherit;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
  }

  /* RESULT CARD */
  .result-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  .result-overlay.visible { display: flex; }
  .result-box {
    background: white;
    border-radius: 20px;
    padding: 30px 24px;
    text-align: center;
    max-width: 320px;
    width: 100%;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(0.7); }
    to { opacity: 1; transform: scale(1); }
  }
  .result-emoji { font-size: 60px; margin-bottom: 10px; }
  .result-title { font-size: 22px; font-weight: 800; color: var(--dark); }
  .result-score { font-size: 40px; font-weight: 800; color: var(--saffron); margin: 10px 0; }
  .result-msg { font-size: 14px; color: #666; margin-bottom: 20px; }
  .result-restart {
    padding: 12px 30px;
    background: var(--saffron);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: inherit;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    width: 100%;
  }

  /* Progress bar */
  .progress-bar {
    height: 4px;
    background: #F0E6D3;
    position: relative;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--saffron), var(--gold));
    transition: width 0.5s ease;
  }

  .premium-banner {
    background: linear-gradient(135deg, #1A1A2E, #0D47A1);
    color: white;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 12px;
  }
  .premium-btn {
    background: var(--gold);
    color: #333;
    border: none;
    padding: 4px 12px;
    border-radius: 20px;
    font-family: inherit;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
  }

  .flag {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
  }
  .flag.hi { background: var(--saffron); }
  .flag.en { background: var(--blue); }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1>üéØ NCERT ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ Quiz</h1>
  <p>‡§ï‡§ï‡•ç‡§∑‡§æ 6-12 | ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‚Ä¢ ‡§≠‡•Ç‡§ó‡•ã‡§≤ ‚Ä¢ ‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞ ‚Ä¢ ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø</p>
</div>

<!-- SUBJECT TABS -->
<div class="subject-tabs" id="subjectTabs">
  <button class="tab-btn active" onclick="setSubject(this, '‡§á‡§§‡§ø‡§π‡§æ‡§∏')">‚öîÔ∏è ‡§á‡§§‡§ø‡§π‡§æ‡§∏</button>
  <button class="tab-btn" onclick="setSubject(this, '‡§≠‡•Ç‡§ó‡•ã‡§≤')">üåç ‡§≠‡•Ç‡§ó‡•ã‡§≤</button>
  <button class="tab-btn" onclick="setSubject(this, '‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞')">üìà ‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞</button>
  <button class="tab-btn" onclick="setSubject(this, '‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞')">üèõÔ∏è ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø</button>
  <button class="tab-btn" onclick="setSubject(this, '‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§')">üé≤ ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§</button>
</div>

<!-- CLASS SELECTOR -->
<div class="class-row" id="classBtns">
  <button class="class-btn active" onclick="setClass(this, 'all')">‡§∏‡§≠‡•Ä</button>
  <button class="class-btn" onclick="setClass(this, '6')">6th</button>
  <button class="class-btn" onclick="setClass(this, '7')">7th</button>
  <button class="class-btn" onclick="setClass(this, '8')">8th</button>
  <button class="class-btn" onclick="setClass(this, '9')">9th</button>
  <button class="class-btn" onclick="setClass(this, '10')">10th</button>
  <button class="class-btn" onclick="setClass(this, '11')">11th</button>
  <button class="class-btn" onclick="setClass(this, '12')">12th</button>
</div>

<!-- STATS BAR -->
<div class="stats-bar">
  <div class="stat">
    <div class="stat-val" id="totalCount">0</div>
    <div class="stat-label">‡§ï‡•Å‡§≤</div>
  </div>
  <div class="stat">
    <div class="stat-val green" id="correctCount">0</div>
    <div class="stat-label">‡§∏‡§π‡•Ä ‚úì</div>
  </div>
  <div class="stat">
    <div class="stat-val red" id="wrongCount">0</div>
    <div class="stat-label">‡§ó‡§≤‡§§ ‚úó</div>
  </div>
  <div class="stat">
    <div class="stat-val" id="streakCount">0üî•</div>
    <div class="stat-label">‡§∏‡•ç‡§ü‡•ç‡§∞‡•Ä‡§ï</div>
  </div>
</div>

<!-- PROGRESS BAR -->
<div class="progress-bar">
  <div class="progress-fill" id="progressFill" style="width:0%"></div>
</div>

<!-- PREMIUM BANNER -->
<div class="premium-banner">
  <span>‚ú® Premium: Unlimited MCQs + Test Series + PDF Notes</span>
  <button class="premium-btn" onclick="showPremium()">‚Çπ99/‡§Æ‡§æ‡§π</button>
</div>

<!-- MAIN CONTENT -->
<div class="main">

  <!-- API KEY SETUP -->
  <div class="api-setup" id="apiSetup">
    <div style="font-size:48px;margin-bottom:12px">ü§ñ</div>
    <h2>Quiz ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</h2>
    <p>‡§Ø‡§π bot Claude AI ‡§∏‡•á unlimited fresh MCQ generate ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Anthropic API Key ‡§°‡§æ‡§≤‡•á‡§Ç‡•§</p>
    <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-ant-api03-..." />
    <button class="api-save-btn" onclick="saveApiKey()">üöÄ Quiz ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
    <p style="margin-top:12px;font-size:11px;color:#AAA">API Key ‡§Ü‡§™‡§ï‡•á device ‡§™‡§∞ save ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‚Ä¢ <a href="https://console.anthropic.com" target="_blank" style="color:var(--saffron)">Free Key ‡§≤‡•á‡§Ç</a></p>
  </div>

  <!-- QUIZ AREA -->
  <div id="quizArea" style="display:none">

    <!-- LOADING -->
    <div class="loading-card" id="loadingCard">
      <div class="loader"></div>
      <div class="loading-text">‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
      <div class="loading-sub">AI ‡§∏‡•á fresh MCQ generate ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à</div>
    </div>

    <!-- ERROR -->
    <div class="error-card" id="errorCard">
      <div style="font-size:36px">‚ö†Ô∏è</div>
      <div style="font-weight:700;margin:8px 0">‡§ï‡•Å‡§õ ‡§ó‡§°‡§º‡§¨‡§°‡§º ‡§π‡•Å‡§à</div>
      <div style="font-size:13px;color:#666" id="errorMsg">Please try again</div>
      <button class="retry-btn" onclick="loadQuestion()">üîÑ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§ï‡•ã‡§∂‡§ø‡§∂</button>
    </div>

    <!-- QUESTION CARD -->
    <div class="question-card" id="questionCard" style="display:none">
      <div class="q-meta">
        <span class="q-badge" id="qBadge">‡§ï‡§ï‡•ç‡§∑‡§æ 6 | ‡§á‡§§‡§ø‡§π‡§æ‡§∏</span>
        <span class="q-exam-tag" id="qExamTag">SSC/UPSC</span>
      </div>
      <div class="q-text-hi" id="qTextHi"></div>
      <div class="q-text-en" id="qTextEn"></div>
      <div class="options" id="optionsContainer"></div>
      <div class="explanation" id="explanation" style="display:none">
        <div class="exp-title">üí° ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ | Explanation</div>
        <div class="exp-text" id="expTextHi"></div>
        <div class="exp-text-en" id="expTextEn"></div>
      </div>
      <button class="next-btn" id="nextBtn" onclick="loadQuestion()">‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‚Üí Next Question</button>
    </div>

  </div>
</div>

<!-- RESULT OVERLAY -->
<div class="result-overlay" id="resultOverlay">
  <div class="result-box">
    <div class="result-emoji" id="resultEmoji">üèÜ</div>
    <div class="result-title">Quiz Complete!</div>
    <div class="result-score" id="resultScore">8/10</div>
    <div class="result-msg" id="resultMsg">‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§®!</div>
    <button class="result-restart" onclick="restartQuiz()">üîÑ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ñ‡•á‡§≤‡•á‡§Ç</button>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let apiKey = localStorage.getItem('ncert_api_key') || '';
let currentSubject = '‡§á‡§§‡§ø‡§π‡§æ‡§∏';
let currentClass = 'all';
let stats = { total: 0, correct: 0, wrong: 0, streak: 0 };
let currentQuestion = null;
let answered = false;

// Question cache to avoid repetition
let questionCache = [];
let usedQuestions = new Set();

// ============================================================
// INIT
// ============================================================
if (window.Telegram && window.Telegram.WebApp) {
  window.Telegram.WebApp.ready();
  window.Telegram.WebApp.expand();
}

window.onload = function() {
  if (apiKey) {
    showQuizArea();
    loadQuestion();
  }
};

// ============================================================
// SUBJECT / CLASS
// ============================================================
function setSubject(btn, subject) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentSubject = subject;
  questionCache = [];
  if (!answered) loadQuestion();
}

function setClass(btn, cls) {
  document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentClass = cls;
  questionCache = [];
  if (!answered) loadQuestion();
}

// ============================================================
// API KEY
// ============================================================
function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key || !key.startsWith('sk-ant')) {
    alert('‡§∏‡§π‡•Ä API Key ‡§°‡§æ‡§≤‡•á‡§Ç (sk-ant-... ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡•Ä ‡§π‡•à)');
    return;
  }
  apiKey = key;
  localStorage.setItem('ncert_api_key', key);
  showQuizArea();
  loadQuestion();
}

function showQuizArea() {
  document.getElementById('apiSetup').style.display = 'none';
  document.getElementById('quizArea').style.display = 'block';
}

// ============================================================
// LOAD QUESTION (Claude API)
// ============================================================
async function loadQuestion() {
  answered = false;
  document.getElementById('nextBtn').classList.remove('visible');
  document.getElementById('questionCard').style.display = 'none';
  document.getElementById('errorCard').classList.remove('visible');
  document.getElementById('loadingCard').style.display = 'block';

  // Use cached questions first
  if (questionCache.length > 0) {
    const q = questionCache.shift();
    displayQuestion(q);
    // Preload more in background
    if (questionCache.length < 2) preloadQuestions();
    return;
  }

  await fetchQuestions();
}

async function preloadQuestions() {
  try {
    const questions = await generateQuestions(3);
    questionCache.push(...questions);
  } catch(e) {}
}

async function fetchQuestions() {
  try {
    const questions = await generateQuestions(1);
    if (questions.length > 0) {
      displayQuestion(questions[0]);
      // Cache rest
      if (questions.length > 1) questionCache.push(...questions.slice(1));
      // Preload more
      preloadQuestions();
    }
  } catch(err) {
    showError(err.message);
  }
}

async function generateQuestions(count = 3) {
  const classText = currentClass === 'all' ? '‡§ï‡§ï‡•ç‡§∑‡§æ 6 ‡§∏‡•á 12 ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡•ã‡§à ‡§≠‡•Ä' : `‡§ï‡§ï‡•ç‡§∑‡§æ ${currentClass}`;
  const examList = 'UPSC, SSC CGL, SSC CHSL, State PSC, Railway NTPC, CTET, NDA, CDS, IAS Prelims';
  
  // Random seed to ensure variety
  const seeds = ['‡§™‡§æ‡§† 1', '‡§™‡§æ‡§† 2', '‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø 3', '‡§µ‡§ø‡§∑‡§Ø 4', '‡§ü‡•â‡§™‡§ø‡§ï 5'];
  const seed = seeds[Math.floor(Math.random() * seeds.length)];
  const randomYear = 2010 + Math.floor(Math.random() * 15);

  const prompt = `‡§Ü‡§™ NCERT ${currentSubject} ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§π‡•à‡§Ç‡•§ ${classText} ‡§ï‡•á ‡§≤‡§ø‡§è ${count} unique MCQ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡§®‡§æ‡§á‡§è ‡§ú‡•ã ${examList} ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á ‡§ó‡§è ‡§π‡•ã‡§Ç‡•§

‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•á ‡§≤‡§ø‡§è JSON format ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§Ç:
{
  "questions": [
    {
      "class": "‡§ï‡§ï‡•ç‡§∑‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ",
      "chapter": "‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ",
      "exam_tag": "‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ú‡•à‡§∏‡•á UPSC 2019",
      "q_hi": "‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç",
      "q_en": "Question in English",
      "options": [
        {"letter": "A", "hi": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ A ‡§π‡§ø‡§Ç‡§¶‡•Ä", "en": "Option A English"},
        {"letter": "B", "hi": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ B ‡§π‡§ø‡§Ç‡§¶‡•Ä", "en": "Option B English"},
        {"letter": "C", "hi": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ C ‡§π‡§ø‡§Ç‡§¶‡•Ä", "en": "Option C English"},
        {"letter": "D", "hi": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ D ‡§π‡§ø‡§Ç‡§¶‡•Ä", "en": "Option D English"}
      ],
      "correct": "A",
      "exp_hi": "‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ ‡§ï‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç 2-3 ‡§µ‡§æ‡§ï‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç",
      "exp_en": "Explanation in English 2-3 sentences"
    }
  ]
}

Random seed for variety: ${seed} ${randomYear}
IMPORTANT: ‡§ï‡•á‡§µ‡§≤ JSON return ‡§ï‡§∞‡•á‡§Ç, ‡§ï‡•ã‡§à extra text ‡§®‡§π‡•Ä‡§Ç‡•§`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 2000,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  if (!response.ok) {
    const err = await response.json();
    throw new Error(err.error?.message || 'API Error: ' + response.status);
  }

  const data = await response.json();
  const text = data.content[0].text;
  
  // Parse JSON
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  if (!jsonMatch) throw new Error('JSON parse error');
  
  const parsed = JSON.parse(jsonMatch[0]);
  return parsed.questions || [];
}

// ============================================================
// DISPLAY QUESTION
// ============================================================
function displayQuestion(q) {
  currentQuestion = q;
  document.getElementById('loadingCard').style.display = 'none';
  document.getElementById('questionCard').style.display = 'block';
  document.getElementById('explanation').style.display = 'none';

  document.getElementById('qBadge').textContent = `${q.class} | ${currentSubject === '‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§' ? (q.subject || currentSubject) : currentSubject}`;
  document.getElementById('qExamTag').textContent = q.exam_tag || 'UPSC/SSC';
  document.getElementById('qTextHi').textContent = q.q_hi;
  document.getElementById('qTextEn').textContent = q.q_en;

  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  
  q.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.innerHTML = `
      <div class="opt-letter">${opt.letter}</div>
      <div class="opt-text">
        <div class="opt-text-hi">${opt.hi}</div>
        <div class="opt-text-en">${opt.en}</div>
      </div>
    `;
    btn.onclick = () => selectAnswer(opt.letter, q.correct, btn);
    container.appendChild(btn);
  });

  // Update progress
  const pct = Math.min((stats.total % 10) * 10, 100);
  document.getElementById('progressFill').style.width = pct + '%';
}

// ============================================================
// SELECT ANSWER
// ============================================================
function selectAnswer(selected, correct, clickedBtn) {
  if (answered) return;
  answered = true;
  stats.total++;

  const allBtns = document.querySelectorAll('.option-btn');
  allBtns.forEach(btn => btn.disabled = true);

  if (selected === correct) {
    clickedBtn.classList.add('correct');
    stats.correct++;
    stats.streak++;
    // Haptic feedback for Telegram
    if (window.Telegram?.WebApp?.HapticFeedback) {
      window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }
  } else {
    clickedBtn.classList.add('wrong');
    stats.wrong++;
    stats.streak = 0;
    // Show correct answer
    allBtns.forEach(btn => {
      const letter = btn.querySelector('.opt-letter').textContent;
      if (letter === correct) btn.classList.add('reveal-correct');
    });
    if (window.Telegram?.WebApp?.HapticFeedback) {
      window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
    }
  }

  // Update stats
  document.getElementById('totalCount').textContent = stats.total;
  document.getElementById('correctCount').textContent = stats.correct;
  document.getElementById('wrongCount').textContent = stats.wrong;
  document.getElementById('streakCount').textContent = stats.streak + 'üî•';

  // Show explanation
  const exp = document.getElementById('explanation');
  document.getElementById('expTextHi').textContent = currentQuestion.exp_hi;
  document.getElementById('expTextEn').textContent = currentQuestion.exp_en;
  exp.style.display = 'block';

  // Show next button
  document.getElementById('nextBtn').classList.add('visible');

  // Show result every 10 questions
  if (stats.total > 0 && stats.total % 10 === 0) {
    setTimeout(showResult, 1500);
  }
}

// ============================================================
// RESULT
// ============================================================
function showResult() {
  const pct = Math.round((stats.correct / stats.total) * 100);
  const emoji = pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üëç' : pct >= 40 ? 'üìö' : 'üí™';
  const msg = pct >= 80 ? '‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§®! Excellent!' : 
              pct >= 60 ? '‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏! Good Job!' :
              pct >= 40 ? '‡§î‡§∞ ‡§Æ‡•á‡§π‡§®‡§§ ‡§ï‡§∞‡•á‡§Ç! Keep Practicing!' : '‡§π‡§æ‡§∞ ‡§Æ‡§§ ‡§Æ‡§æ‡§®‡•ã! Don\'t Give Up!';
  
  document.getElementById('resultEmoji').textContent = emoji;
  document.getElementById('resultScore').textContent = `${stats.correct}/${stats.total}`;
  document.getElementById('resultMsg').textContent = msg;
  document.getElementById('resultOverlay').classList.add('visible');
}

function restartQuiz() {
  document.getElementById('resultOverlay').classList.remove('visible');
  loadQuestion();
}

function showError(msg) {
  document.getElementById('loadingCard').style.display = 'none';
  document.getElementById('errorCard').classList.add('visible');
  document.getElementById('errorMsg').textContent = msg;
}

function showPremium() {
  alert('üåü Premium Plan\n\n‚úÖ Unlimited MCQs\n‚úÖ Full NCERT Test Series\n‚úÖ Chapter-wise PDFs\n‚úÖ Performance Analytics\n‚úÖ Daily Quiz Challenges\n\n‚Çπ99/‡§Æ‡§æ‡§π | ‚Çπ699/‡§∏‡§æ‡§≤\n\nContact: @your_username');
}
</script>
</body>
</html>
